name: Pack Packages

on:
  workflow_dispatch:
  
jobs:
  clang:
    # We pack an archive using Qt6 in clang64 environment.
    runs-on: windows-latest

    steps:
    - name: Setup MSYS2 Environment
      uses: msys2/setup-msys2@v2
      with:
        msystem: clang64
        update: true
        location: D:\
        pacboy: >-
          toolchain:p
          cmake:p
          ninja:p
          jq:p
          angleproject:p
          qt6-base:p
          qt6-tools:p
          qt6-translations:p
          qt6-imageformats:p

    - name: Checkout
      uses: actions/checkout@v4
      with:
        repository: zxunge/FreePictureSplitter
        path: FreePictureSplitter
        submodules: recursive
        
    - name: Build, deploy and copy dependencies
      shell: msys2 {0}
      run: |
        cd FreePictureSplitter/
        # We do not want PCH to be enabled when building on GitHub Action
        cmake -DWITH_PCH=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/opt/FreePictureSplitter -B build .
        cmake --build build -j
        cmake --install build
        
        # Copy DLLs
        for dll in libb2-1.dll               \
                   libfreetype-6.dll         \
                   libiconv-2.dll            \
                   libjasper.dll             \
                   libpcre2-8-0.dll          \
                   libwebp-7.dll             \  
                   libzstd.dll               \
                   libbrotlicommon.dll       \
                   libicudt77.dll            \
                   libjpeg-8.dll             \
                   libpng16-16.dll           \
                   libwebpdecoder-3.dll      \
                   vulkan-1.dll              \
                   libbrotlidec.dll          \   
                   libglib-2.0-0.dll         \
                   libicuin77.dll            \
                   libmd4c.dll               \
                   libsharpyuv-0.dll         \
                   libwebpdemux-2.dll        \ 
                   zlib1.dll                 \
                   libbz2-1.dll              \
                   libgraphite2.dll          \
                   libicuuc77.dll            \
                   libmng-2.dll              \
                   libwebpmux-3.dll          \
                   libdouble-conversion.dll  \
                   libharfbuzz-0.dll         \
                   libintl-8.dll             \
                   libpcre2-16-0.dll         \
                   libturbojpeg.dll          \
                   libwinpthread-1.dll
        do
          cp -f /clang64/bin/$dll /opt/FreePictureSplitter/
        done

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: FreePictureSplitter-clang64-qt6-all
        path: D:/msys64/opt/FreePictureSplitter