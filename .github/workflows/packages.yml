name: Pack Packages

on:
  workflow_dispatch:
  
jobs:
  qt5_win64:
    # We pack an archive using Qt5.15 in the mingw64 environment of MSYS2.
    runs-on: windows-latest
        
    steps:
    - name: Setup MSYS2 Environment
      uses: msys2/setup-msys2@v2
      with:
        msystem: mingw64
        update: true
        install: >-
          patch
          make
        pacboy: >-
          toolchain:p
          cmake:p
          ninja:p
          angleproject:p
          qt5-base:p
          qt5-tools:p
          qt5-translations:p
          qt5-imageformats:p
    
    - name: Checkout
      uses: actions/checkout@v4
      with:
        repository: zxunge/FreePictureSplitter
        path: FreePictureSplitter
        submodules: recursive
        ref: 3.x
        fetch-depth: 1
        
    - name: Build Qt IFW Using Qt5
      shell: msys2 {0}
      run: |
        # Download and extract source
        wget -q https://download.qt.io/archive/qt-installer-framework/4.10.0/installer-framework-everywhere-src-4.10.0.tar.xz
        tar xf installer-framework-everywhere-src-4.10.0.tar.xz
        
        # Get and apply patches
        wget -q https://github.com/msys2/MINGW-packages/raw/refs/heads/master/mingw-w64-qt-installer-framework/0002-add-installation-stuff-to-pro-files.patch
        wget -q https://github.com/msys2/MINGW-packages/raw/refs/heads/master/mingw-w64-qt-installer-framework/0003-add-recursive-option-to-rmdir-operation.patch
        wget -q https://github.com/msys2/MINGW-packages/raw/refs/heads/master/mingw-w64-qt-installer-framework/0004-add-dirExists-fuction.patch
        wget -q https://github.com/msys2/MINGW-packages/raw/refs/heads/master/mingw-w64-qt-installer-framework/0006-Don-t-remove-files-that-live-outside-of-path.patch
        wget -q https://github.com/msys2/MINGW-packages/raw/refs/heads/master/mingw-w64-qt-installer-framework/0010-fix-version-pass-to-windres.patch
        wget -q https://github.com/msys2/MINGW-packages/raw/refs/heads/master/mingw-w64-qt-installer-framework/0011-fix-redefined-mode_t.patch
        wget -q https://github.com/msys2/MINGW-packages/raw/refs/heads/master/mingw-w64-qt-installer-framework/0012-get_timezone-not-available-on-msvcrt.patch
        wget -q https://github.com/msys2/MINGW-packages/raw/refs/heads/master/mingw-w64-qt-installer-framework/0013-fix-libarchive-linking.patch
        cd installer-framework-everywhere-src-4.10.0/
        for file in ../*.patch; do
            if [ -f "$file" ]; then
                patch -p1 < "$file"
            fi
        done
        
        # Build the source and install
        mkdir build && cd $_
        qmake CONFIG+=release                       \
            CONFIG+=libarchive                      \
            CONFIG+=no_testcase_installs            \
            IFW_ZLIB_LIBRARY=/mingw64/lib/libz.a    \
            IFW_BZIP2_LIBRARY=/mingw64/lib/libbz2.a \
            IFW_LZMA_LIBRARY=/mingw64/lib/liblzma.a \
            ../installerfw.pro
        make
        make INSTALL_ROOT="/mingw64" install
        
    - name: Build, deploy and copy dependencies
      shell: msys2 {0}
      run: |
        cd FreePictureSplitter/
        # We do not want PCH to be enabled when building on GitHub Action
        cmake -DWITH_PCH=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/opt/freepicturesplitter/packages/com.zxunge.freepicturesplitter.app/data -B build .
        cmake --build build -j
        cmake --build build --target release_translations
        cmake --install build
        cd /opt/freepicturesplitter/packages/com.zxunge.freepicturesplitter.app/data/
        windeployqt ./FreePictureSplitter.exe --dir . --libdir . --plugindir plugins --qml-deploy-dir qml --translationdir translations --force --compiler-runtime --qtpaths /mingw64/bin/qtpaths6.exe
        # Copy dependent dlls
        win_dlls=("libfreetype-6.dll"         \
                  "libiconv-2.dll"            \
                  "libjasper.dll"             \
                  "libpcre2-8-0.dll"          \
                  "libwebp-7.dll"             \  
                  "libzstd.dll"               \
                  "libbrotlicommon.dll"       \
                  "libicudt77.dll"            \
                  "libjpeg-8.dll"             \
                  "libpng16-16.dll"           \
                  "libwebpdecoder-3.dll"      \
                  "vulkan-1.dll"              \
                  "libbrotlidec.dll"          \
                  "libfontconfig-1.dll"       \
                  "libicuin77.dll"            \
                  "libmd4c.dll"               \
                  "libsharpyuv-0.dll"         \
                  "libwebpdemux-2.dll"        \ 
                  "zlib1.dll"                 \
                  "libbz2-1.dll"              \
                  "libgraphite2.dll"          \
                  "libicuuc77.dll"            \
                  "libmng-2.dll"              \
                  "libwebpmux-3.dll"          \
                  "libdouble-conversion.dll"  \
                  "libharfbuzz-0.dll"         \
                  "libintl-8.dll"             \
                  "libpcre2-16-0.dll"         \
                  "libturbojpeg.dll"          \
                  "libtiff-6.dll"             \
                  "libtiffxx-6.dll")
        for dll in ${win_dlls[@]};
        do
          cp -f /mingw64/bin/$dll ./
        done
        
    - name: Create an installer using Qt IFW
      shell: msys2 {0}
      run: |
        mkdir -p /opt/freepicturesplitter/config
        mkdir -p /opt/freepicturesplitter/packages/com.zxunge.freepicturesplitter.app/meta
        cp -f FreePictureSplitter/config/config.xml /opt/freepicturesplitter/config/
        cp -f FreePictureSplitter/config/package.xml /opt/freepicturesplitter/packages/com.zxunge.freepicturesplitter.app/meta/
        cp -f FreePictureSplitter/LICENSE /opt/freepicturesplitter/packages/com.zxunge.freepicturesplitter.app/meta/
        cp -f FreePictureSplitter/src/resources/fps.ico /opt/freepicturesplitter/config/
        cp -f FreePictureSplitter/src/resources/fps.png /opt/freepicturesplitter/config/
        binarycreator --offline-only -t /mingw64/bin/installerbase.exe -p /opt/freepicturesplitter/packages -c /opt/freepicturesplitter/config/config.xml FreePictureSplitterSetup-qt5-win64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: FreePictureSplitterSetup-qt5-win64
        path: FreePictureSplitterSetup-qt5-win64.exe
